import openpyxl
import time
from selenium.webdriver.chrome.options import Options
from selenium.webdriver import Chrome

# opens the excel spreadsheet
wb = openpyxl.load_workbook('Expiring Domains 2017.xlsx')
# stores the november 2018 sheet to 'sheet'
sheet = wb['November 2018']


def main():
    try:
        # logs in the CRM via headless chrome
        opts = Options()
        opts.set_headless()
        assert opts.headless
        browser = Chrome(options=opts)
        browser.get('https://cocreate.ad.iq/customers?sort=&direction=&q=&firstdate=&lastdate=')
        emailElem = browser.find_element_by_id('admin_email')
        emailElem.send_keys('josephs@ad.iq')
        passwordElem = browser.find_element_by_id('admin_password')
        passwordElem.send_keys('Js709939#')
        passwordElem.submit()
        # logged in
        time.sleep(1.0)

        # inputs the domain into the crm search bar
        searchBar = browser.find_element_by_css_selector('#customer-filters-form > div > div.keywordsearchbox > input')
        searchBar.send_keys(sheet.cell(row=i, column=2).value)
        # clicks the 'apply' button
        button = browser.find_element_by_css_selector('#customer-filters-form > div > div.filtermasterwrapperbox > div > div.filter-btn_boxwrapper > div.applybtn_horizontalflex > button')
        button.click()
        time.sleep(1.5)
        # if nothing is found, search on beranked
        customerContent = browser.find_element_by_css_selector(
            '#customers-content > div.graph-masterwrapper > div.graph-headerbox > div > div')
        if customerContent.text == 'Customer Profiles (Not Found)':
            print('Not found in Ad.IQ')
            # goes into BeRanked and repeats the process
            hamburger = browser.find_element_by_css_selector(
                'body > section:nth-child(3) > div > div > div > div.top_line_left_block > div.menu-main-root > a > i')
            hamburger.click()
            time.sleep(1.5)
            beranked = browser.find_element_by_css_selector(
                'body > section:nth-child(4) > div.menu-main.open > div > div.menu-main-columns > div:nth-child(4) > div.menu-main-column-list > a')
            beranked.click()
            time.sleep(1.5)
            berankedEmailElem = browser.find_element_by_id('admin_email')
            berankedEmailElem.send_keys('josephs@ad.iq')
            berankedPasswordElem = browser.find_element_by_id('admin_password')
            berankedPasswordElem.send_keys('$!2018JoeS!$')
            berankedPasswordElem.submit()
            time.sleep(1.0)
            berankedHamburger = browser.find_element_by_css_selector(
                'body > section:nth-child(3) > div > div > div > div.top_line_left_block > div.menu-main-root > a')
            berankedHamburger.click()
            time.sleep(1.0)
            berankedCustomers = browser.find_element_by_css_selector(
                'body > section:nth-child(4) > div.menu-main.open > div > div.menu-main-columns > div:nth-child(2) > div.menu-main-column-list > a:nth-child(1)')
            berankedCustomers.click()
            berankedSearchbar = browser.find_element_by_css_selector(
                '#customer-filters-form > div > div.keywordsearchbox > input')
            berankedSearchbar.send_keys(sheet.cell(row=i, column=2).value)
            berankedButton = browser.find_element_by_css_selector(
                '#customer-filters-form > div > div.filtermasterwrapperbox > div > div.filter-btn_boxwrapper > div.applybtn_horizontalflex > button')
            berankedButton.click()
            time.sleep(1.5)
            berankedCustomerContent = browser.find_element_by_css_selector(
                '#customers-content > div.graph-masterwrapper > div.graph-headerbox > div > div')
            if berankedCustomerContent.text == 'Customer Profiles (Not Found)':
                print('Not found in BeRanked')
                cell = sheet.cell(row=i, column=5)
                cell.value = 'Not found in either Ad.IQ or BeRanked'
            else:
                berankedCustomerStatus = browser.find_element_by_css_selector(
                    '#customer-results > div > div:nth-child(3) > div > div > span')
                print(berankedCustomerStatus.text)
                cell = sheet.cell(row=i, column=5)
                cell.value = berankedCustomerStatus.text
        # updates the spreadsheet
        else:
            customerStatus = browser.find_element_by_css_selector('#customer-results > div > div:nth-child(3) > div > div > span')
            print(customerStatus.text)
            cell = sheet.cell(row=i, column=5)
            cell.value = customerStatus.text
    except:
        print('error')
    # closes chrome
    browser.quit()


# 2nd parameter needs to be +1 higher than the last row on the excel sheet; example 101 to get top 100
# will do the first 10 iterations in this example
for i in range(2, 11):
    print(sheet.cell(row=i, column=2).value)
    main()
# saves and overwrites the excel file
wb.save('Expiring Domains 2017.xlsx')
print('Done')
